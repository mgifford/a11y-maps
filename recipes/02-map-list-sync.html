<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe 02: Map-List Synchronization</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
            line-height: 1.5;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        @media (max-width: 600px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .map-container {
            height: 400px;
            border: 2px solid #ccc;
            border-radius: 4px;
        }

        .location-list {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 2px solid #ccc;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
        }

        .location-item {
            border-bottom: 1px solid #eee;
        }

        .location-btn {
            padding: 1rem;
        }

        .location-btn:hover {
            background: #f5f5f5 !important;
        }

        .location-btn:focus {
            outline: 3px solid #005fcc;
            outline-offset: -3px;
            background: #eef !important;
        }

        .location-btn[aria-current="true"] {
            background: #e6f0ff !important;
            border-left: 5px solid #005fcc;
        }

        /* Ensure map focus visibility */
        .leaflet-marker-icon:focus {
            outline: 3px solid #005fcc;
            outline-offset: 2px;
        }
    </style>
</head>

<body>

    <main>
        <nav>
            <a href="../index.html">‚Üê Back to Menu</a>
        </nav>

        <h1>Recipe 02: Bi-Directional Sync</h1>
        <p>
            The "Golden Rule" of accessible mapping:
            <strong>Everything on the map must be available in a list.</strong>
        </p>
        <p>Try navigating via keyboard. Selecting an item in the list highlights the map marker, and vice-versa.</p>

        <div class="layout">
            <!-- The List (Primary Interface for many users) -->
            <section aria-labelledby="list-heading">
                <h2 id="list-heading" class="visually-hidden">Locations List</h2>
                <ul id="location-list" class="location-list" role="list" aria-label="List of service locations">
                    <!-- Populated by JS -->
                </ul>
            </section>

            <!-- The Map (Secondary Visual Aid) -->
            <section aria-labelledby="map-heading">
                <h2 id="map-heading" class="visually-hidden">Map View</h2>
                <div id="map" class="map-container" role="application" aria-label="Map view of locations" tabindex="0">
                </div>
            </section>
        </div>

        <section style="margin-top: 2rem; border-top: 1px solid #ccc; padding-top: 1rem;">
            <h2>Accessibility Features</h2>
            <ul>
                <li><strong>Bi-Directional Sync:</strong> Selecting an item in the list highlights it on the map.
                    Selecting a marker on the map highlights it in the list. This connects the accessible text
                    representation with the visual spatial representation.</li>
                <li><strong>Semantic List:</strong> The locations are simple <code>&lt;button&gt;</code> elements inside
                    a <code>&lt;ul&gt;</code>. This is the most robust, accessible pattern for a selectable list.</li>
                <li><strong>State Management:</strong> We use <code>aria-current="true"</code> to programmatically
                    indicate which list item is currently selected, regardless of how it was triggered.</li>
            </ul>

            <h2>Try This</h2>
            <ol>
                <li>Click "Public Library" in the list. Notice the map marker popup opens.</li>
                <li><strong>Keyboard Check:</strong> Tab into the map markers. Press <code>Enter</code> on a marker.
                    Notice the focus moves to or highlights the corresponding list item.</li>
            </ol>
        </section>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Data Source
        const locations = [
            { id: 1, name: "Community Center", coords: [51.505, -0.09], desc: "Open 9am-5pm" },
            { id: 2, name: "Public Library", coords: [51.500, -0.095], desc: "Free wifi available" },
            { id: 3, name: "Health Clinic", coords: [51.510, -0.08], desc: "Urgent care services" },
            { id: 4, name: "Post Office", coords: [51.508, -0.10], desc: "Last pickup 5:30pm" }
        ];

        // Init Map
        const map = L.map('map').setView([51.505, -0.09], 14);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        const markers = {};
        const listItems = {};

        // Render List & Map Markers
        const listEl = document.getElementById('location-list');

        locations.forEach(loc => {
            // 1. Create List Item
            const li = document.createElement('li');
            li.className = 'location-item';
            li.id = `loc-${loc.id}`;

            // Create wrapper button for accessibility
            const btn = document.createElement('button');
            btn.className = 'location-btn';
            btn.style.cssText = 'width: 100%; text-align: left; background: none; border: none; padding: 0; font: inherit; cursor: pointer; display: block;';
            btn.innerHTML = `<strong>${loc.name}</strong><br><small>${loc.desc}</small>`;

            btn.addEventListener('click', () => selectLocation(loc.id));

            li.appendChild(btn);
            listEl.appendChild(li);
            listItems[loc.id] = btn; // Track buttons, not LIs

            // 2. Create Map Marker
            const marker = L.marker(loc.coords, {
                title: loc.name,
                alt: loc.name,
                keyboard: true
            }).addTo(map);

            marker.on('click', () => selectLocation(loc.id));

            // Attach keyboard listener to DOM element
            if (marker.getElement()) {
                marker.getElement().addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectLocation(loc.id);
                    }
                });
            }

            // We store the ID on the marker for reference
            marker.featureId = loc.id;
            markers[loc.id] = marker;
        });

        // Selection Logic
        function selectLocation(id) {
            // Update List State
            Object.values(listItems).forEach(item => item.removeAttribute('aria-current'));
            const selectedItem = listItems[id];
            if (selectedItem) {
                selectedItem.setAttribute('aria-current', 'true');
                selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                // We focus the list item if the interaction came from the map
                // But if it came from the list, we keep focus where it is
            }

            // Update Map State
            Object.values(markers).forEach(m => m.setOpacity(0.6));
            const selectedMarker = markers[id];
            if (selectedMarker) {
                selectedMarker.setOpacity(1);
                selectedMarker.openPopup();
                map.flyTo(selectedMarker.getLatLng(), 15);
            }
        }
    </script>
</body>

</html>